trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: SonorSecrets
  - name: dockerHubUser
    value: $(docker-username)
  - name: dockerHubPass
    value: $(docker-password)

stages:

# ğŸ” SonarCloud Analysis (via CLI)
- stage: SonarAnalysis
  displayName: "ğŸ” SonarCloud Analysis"
  jobs:
    - job: RunSonar
      displayName: "Analyze with SonarScanner CLI"
      steps:
        - checkout: self

        - script: |
            sudo apt-get update
            sudo apt-get install -y unzip openjdk-11-jre
            wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
            unzip sonar-scanner-cli-5.0.1.3006-linux.zip
            export PATH=$PATH:$(pwd)/sonar-scanner-5.0.1.3006-linux/bin
            sonar-scanner \
              -Dsonar.projectKey=firaszouaoui_todo-app \
              -Dsonar.organization=firaszouaoui \
              -Dsonar.sources=backend,frontend \
              -Dsonar.exclusions=**/node_modules/**,**/build/**,**/coverage/**,**/*.test.js \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.login=$SONAR_TOKEN
          displayName: "ğŸ” Run SonarScanner CLI"

# ğŸ” Trivy Security Scan
- stage: SecurityScan
  displayName: "ğŸ” Trivy Image Scan"
  dependsOn: SonarAnalysis
  jobs:
    - job: TrivyScan
      displayName: "Scan Docker Images"
      steps:
        - checkout: self

        - script: |
            sudo apt-get update
            sudo apt-get install -y wget
            wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.49.1_Linux-64bit.deb
            sudo dpkg -i trivy_0.49.1_Linux-64bit.deb
          displayName: "ğŸ“¦ Install Trivy"

        - script: |
            docker build -t backend-img ./backend
            docker build -t frontend-img ./frontend
          displayName: "ğŸ³ Build Docker Images"

        - script: |
            trivy image backend-img > trivy-backend-report.txt
            trivy image frontend-img > trivy-frontend-report.txt
          displayName: "ğŸ§ª Scan Docker Images"

        - task: PublishBuildArtifacts@1
          inputs:
            pathToPublish: 'trivy-backend-report.txt'
            artifactName: 'Trivy_Backend_Report'

        - task: PublishBuildArtifacts@1
          inputs:
            pathToPublish: 'trivy-frontend-report.txt'
            artifactName: 'Trivy_Frontend_Report'

# ğŸš€ Build & Push Docker Images
- stage: DockerBuildAndPush
  displayName: "ğŸš€ Build & Push Docker Images"
  dependsOn: SecurityScan
  jobs:
    - job: PushImages
      displayName: "Push Docker Images to DockerHub"
      steps:
        - checkout: self

        - task: DockerInstaller@0
          inputs:
            dockerVersion: 'latest'

        - script: |
            echo $(dockerHubPass) | docker login -u $(dockerHubUser) --password-stdin
          displayName: "ğŸ” Docker Login"

        - script: |
            docker build -t $(dockerHubUser)/todo-app-backend:latest ./backend
            docker build -t $(dockerHubUser)/todo-app-frontend:latest ./frontend
          displayName: "ğŸ”¨ Build Docker Images"

        - script: |
            docker push $(dockerHubUser)/todo-app-backend:latest
            docker push $(dockerHubUser)/todo-app-frontend:latest
          displayName: "ğŸ“¦ Push Docker Images"
